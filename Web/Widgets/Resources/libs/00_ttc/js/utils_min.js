let originalSize={width:0,height:0};function isFullscreen(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement}function toggleFullscreen(){const e=document.getElementById("Container_ID");e&&(isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen():e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen&&e.mozRequestFullScreen())}function reintChart(){changeTheme(cwidget.theme)}function updateSizeDisplay(){const e=document.getElementById("Container_ID"),t=document.getElementById("originalSizeDisplay");if(!e||!t||"function"!=typeof e.getBoundingClientRect)return;const n=e.getBoundingClientRect(),i=Math.round(n.width),l=Math.round(n.height);t.innerHTML=`W:${i}px&nbsp;H:${l}px`,isFullscreen()||0!==originalSize.width||0!==originalSize.height||(originalSize.width=i,originalSize.height=l)}document.addEventListener("fullscreenchange",(function(){const e=document.getElementById("enterFullscreenBtn")?.querySelector("img");e&&(e.src=isFullscreen()?"../Resources/Images/compress-solid.svg":"../Resources/Images/expand-solid.svg");const t=document.documentElement,n=document.body,i=document.getElementById("Container_ID");!isFullscreen()&&originalSize.width&&originalSize.height&&(t.style.width=originalSize.width+"px",t.style.height=originalSize.height+"px",n.style.width=originalSize.width+"px",n.style.height=originalSize.height+"px",i.style.width=originalSize.width+"px",i.style.height=originalSize.height+"px",reintChart()),window.myChart&&"function"==typeof myChart.resize&&myChart.resize(),updateSizeDisplay()}));let pendingResize=!1;function safeUpdateSizeDisplay(){pendingResize||(pendingResize=!0,requestAnimationFrame((()=>{updateSizeDisplay(),pendingResize=!1})))}window.addEventListener("load",updateSizeDisplay),window.addEventListener("resize",safeUpdateSizeDisplay);const settingsToggleBtn=document.getElementById("settingsToggle");settingsToggleBtn&&(settingsToggleBtn.onclick=function(){const e=document.getElementById("settingsPopup");if(e.style.display="block"===e.style.display?"none":"block","block"===e.style.display){const e=cwidget?.titleName||"",t=cwidget?.unit||"";document.getElementById("chartTitleInput").value=e,document.getElementById("unitInput").value=t}}),document.addEventListener("click",(function(e){const t=document.getElementById("settingsPopup"),n=document.getElementById("settingsToggle");t.contains(e.target)||n.contains(e.target)||(t.style.display="none")}));const applyBtn=document.getElementById("applySettings");applyBtn&&(applyBtn.onclick=function(){const e=document.getElementById("chartTitleInput").value,t=document.getElementById("unitInput").value;cwidget.titleName=e,cwidget.unit=t}),flatpickr("#startDT",{enableTime:!0,time_24hr:!0,dateFormat:"Y-m-d",defaultDate:new Date}),flatpickr("#endDT",{enableTime:!0,time_24hr:!0,dateFormat:"Y-m-d",defaultDate:new Date});const chartSetting=document.getElementById("chartSetting");function loadConfigFromFile(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=function(e){try{const t=JSON.parse(e.target.result);for(const e in t)if(t.hasOwnProperty(e)){const n=document.getElementById(e);n&&(n.value=t[e])}alert("✅ Đã nạp file cấu hình thành công!")}catch(e){alert("❌ Lỗi khi đọc file JSON: "+e.message)}},n.readAsText(t)}function downloadJsonFile(e,t){const n=JSON.stringify(t),i=new Blob([n],{type:"application/json"}),l=URL.createObjectURL(i),o=document.createElement("a");o.href=l,o.download=e,o.click(),URL.revokeObjectURL(l)}function saveConfig(){const e=["titleName","deviceID","sqlDNS"];for(let t of e){if(!document.getElementById(t).value.trim())return alert('❌ Trường "'+t+'" không được để trống!'),void document.getElementById(t).focus()}const t={deviceID:document.getElementById("deviceID").value.trim(),sqlDNS:document.getElementById("sqlDNS").value.trim(),dbName:document.getElementById("dbName").value.trim(),dbTable:document.getElementById("dbTable").value.trim(),dbColumn:document.getElementById("dbColumn").value.split(",").map((e=>e.trim())).filter(Boolean),dataName:document.getElementById("dataName").value.split(",").map((e=>e.trim())).filter(Boolean),type:document.getElementById("type").value.split(",").map((e=>e.trim())).filter(Boolean)},n={title:document.getElementById("titleName").value.trim(),dataName:document.getElementById("dataName").value.split(",").map((e=>e.trim())).filter(Boolean),type:document.getElementById("type").value.split(",").map((e=>e.trim())).filter(Boolean),xAxisName:document.getElementById("xAxisName").value.trim(),xAxisUnit:document.getElementById("xAxisUnit").value.trim(),yAxisName:document.getElementById("yAxisName").value.trim(),yAxisUnit:document.getElementById("yAxisUnit").value.trim()},i=t.deviceID+"_Cconfig.json";downloadJsonFile(t.deviceID+"_Dconfig.json",t),downloadJsonFile(i,n),cwidget.deviceID=document.getElementById("deviceID").value.trim(),cwidget.titleName=document.getElementById("titleName").value.trim(),cwidget.tagList=document.getElementById("dbColumn").value.trim().split(",").slice(1).join(","),LoadChartConfig()}function resetForm(){document.querySelectorAll("#configForm input").forEach((e=>e.value=""))}chartSetting.addEventListener("click",(()=>{document.getElementById("titleName").value=cwidget.titleName||"",document.getElementById("deviceID").value=cwidget.deviceID||""}));const sqlReques=document.getElementById("applyDate"),startDT1=document.getElementById("startDT1"),endDT1=document.getElementById("endDT1"),datePickerContainer=document.getElementById("datePickerContainer"),inputNumOfRow=document.getElementById("inputNumOfRow"),ClassinputNumOfRow=document.getElementById("ClassinputNumOfRow"),toggleBtn=document.getElementById("modeToggle");function detecReadMode(){const e=toggleBtn.querySelector("i"),t=(new Date).toISOString().slice(0,10);1==readMode?(toggleBtn.title="Realtime",startDT1.value=cwidget.startDT||t,endDT1.value=cwidget.endDT||t,ClassinputNumOfRow.classList.add("d-none"),datePickerContainer.classList.remove("d-none"),e.className="bi bi-clock-history",toggleBtn.innerHTML='<i class="bi bi-clock-history"></i>'):0==readMode&&(toggleBtn.title="History",datePickerContainer.classList.add("d-none"),ClassinputNumOfRow.classList.remove("d-none"),e.className="bi bi-lightning",toggleBtn.innerHTML='<i class="bi bi-lightning"></i>')}toggleBtn.addEventListener("click",(()=>{toggleBtn.querySelector("i").classList.contains("bi-lightning")?(cwidget.readMode=!0,readMode=1):(readMode=0,cwidget.readMode=!1)})),window.addEventListener("load",(function(){const e=toggleBtn.querySelector("i");document.getElementById("datePickerContainer"),e.classList.contains("bi-clock-history")})),sqlReques.addEventListener("click",(()=>{cwidget.startDT=startDT1.value,cwidget.endDT=endDT1.value,cwidget.sqlQuery=!0,cwidget.sqlQueryDone=!1,cwidget.dispatchEvent("sqlQueryHistory")})),inputNumOfRow.addEventListener("change",(function(){const e=parseInt(this.value);isNaN(e)||(cwidget.numOfRow=e)}));